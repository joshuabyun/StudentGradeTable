<!doctype html>
<html>
<head>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.min.js"></script>
    <meta name="viewport" content="initial-scale=1, user-scalable=no">
</head>
<body ng-app="myApp" ng-controller="namingController as fc">
<div class="container" ng-controller="inputController as ic">
    <div class="page-header">
        <h1 class="visible-md visible-lg">{{fc.title}}
            <small class="pull-right">{{fc.grade}}<span class="avgGrade label label-default">{{ic.avg}}</span></small>
        </h1>
        <h3 class=" visible-xs visible-sm">{{fc.title}}
            <small class="pull-right">{{fc.grade}}<span class="avgGrade label label-default">{{ic.avg}}</span></small>
        </h3>
    </div>
    <div class="student-add-form form-group col-sm-4 col-sm-push-8">
        <form role="form" class="form-group">
            <h4>{{fc.addStudent}}</h4>
            <div class="input-group form-group">
                <span class="input-group-addon">
                    <span class="glyphicon glyphicon-user"></span>
                </span>
                <input type="text" class="form-control" placeholder="Student Name" ng-model="ic.student.name">
            </div>
            <div class="input-group form-group">
                <span class="input-group-addon">
                    <span class="glyphicon glyphicon-list-alt"></span>
                </span>
                <input type="text" class="form-control" placeholder="Student Course" ng-model="ic.student.course">
            </div>
            <div class="input-group form-group">
                <span class="input-group-addon">
                    <span class="glyphicon glyphicon-education"></span>
                </span>
                <input type="text" class="form-control" placeholder="Student Grade" ng-model="ic.student.grade">
            </div>
            <div class="form-group">
                <button type="button" class="btn btn-success" ng-click="ic.addClicked()">{{fc.add}}</button>
                <button type="button" class="btn btn-default" ng-click="ic.cancelClicked()">{{fc.cancel}}</button>
            </div>
            <div class="form-group">
                <button type="button" class="btn btn-warning" ng-click="ic.getDataFromServer()">{{fc.getData}}</button>
            </div>
        </form>
    </div>
    <div class="student-list-container  col-sm-8 col-sm-pull-4">
        <table class="student-list table table-striped">
            <thead>
                <tr>
                    <th>{{fc.studentName}}</th>
                    <th>{{fc.studentCourse}}</th>
                    <th>{{fc.studentGrade}}</th>
                    <th>{{fc.operation}}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>{{ic.student.name}}</td>
                    <td>{{ic.student.course}}</td>
                    <td>{{ic.student.grade}}</td>
                </tr>
                <tr ng-repeat = "obj in ic.studentArray track by $index">
                    <td>{{obj.name}}</td>
                    <td>{{obj.course}}</td>
                    <td>{{obj.grade}}</td>
                    <td><button class="btn btn-danger" ng-click="ic.delArrElement($index)">Delete</button></td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        var app = angular.module("myApp", []);

        app.controller("namingController", function(){
            this.title = "Student Grade Table";
            this.grade = "Grade Average : ";
            this.addStudent = "Add Student";
            this.add = "Add";
            this.cancel = "Cancel";
            this.getData = "Get Data From Server";
            this.studentName = "Student Name";
            this.studentCourse = "Student Course";
            this.studentGrade = "Student Grade";
            this.operation = "Operation";
        });

        app.controller("inputController",function($scope,$http){
            this.studentArray = [];
            this.student = {id:null};
            this.avg = 0;
            this.addClicked = function(){
                this.addStudent(this.student);
                this.clearAddStudentForm();
                this.sendDataToServer();
                this.calculateAverage();
            };
            this.addStudent = function(studentObj){
                this.studentArray.push(studentObj);
            };
            this.cancelClicked = function(){
                this.clearAddStudentForm();
            };
            this.clearAddStudentForm = function(){
                this.student ={};
            };
            this.delArrElement = function(index){
                console.log("index delArrElement index  : ",index);
                this.requestServerDelete(index);
                this.studentArray.splice(index,1)
                this.calculateAverage();
            };

            this.calculateAverage = function(){
                console.log('average calculation initiated');
                var totalGrade = 0;
                if(this.studentArray.length == 0){
                    var averageGrade = 0;
                }
                else{
                    for (var i = 0; i < this.studentArray.length; i++){
                          totalGrade += parseFloat(this.studentArray[i].grade);
                          var averageGrade = totalGrade / this.studentArray.length;
                    }
                }
                console.log("newly calculated avg : ", averageGrade);
                this.avg = averageGrade.toFixed(2);
            }

            this.sendDataToServer = function(){
                var self =this;
                var req = {
                    method: 'POST',
                    url: "http://s-apis.learningfuze.com/sgt/create",
//                    headers: {
//                        'Content-Type': "application/x-www-form-urlencoded"
//                    },
                    data : $.param({
                        api_key:"Syh9yhgpdU",
                        name : self.studentArray[self.studentArray.length-1].name,
                        course : self.studentArray[self.studentArray.length-1].course,
                        grade : self.studentArray[self.studentArray.length-1].grade}),
                    dataType : "json"
                };
                 $http(req).then(function successCallback(response){
                     console.log("Data Sent");
                     console.log(response);
                 }).catch(function errorCallback(response){
                     console.log("Data Not Sent")
                 })
            };

            this.getDataFromServer = function(){//what does each element need in terms of controller?
                var self = this;
                this.studentArray = [];
                var req = {
                    method: 'POST',
                    url: 'http://s-apis.learningfuze.com/sgt/get',
//                    headers: {
//                        'Content-Type': "application/x-www-form-urlencoded"
//                    },
                    data : $.param({api_key:"Syh9yhgpdU"}),
                    dataType : "json"
                };
                $http(req).then(function successCallback(response) {
                    // this callback will be called asynchronously
                    // when the response is available
                    console.log("new info fetched from the server : ",response);
                    console.log(response.data.data.length);
                    for (var i = 0; i < response.data.data.length; i++ ){
                        self.addStudent(response.data.data[i]);
                    };
                    self.calculateAverage();
                }, function errorCallback(response){
                    console.log('hello');
                })
            };

            this.requestServerDelete = function(studentId){
                var self = this;
                console.log(self.studentArray[studentId].id);
                console.log(self.studentArray[studentId]);
                var req = {
                    url : "http://s-apis.learningfuze.com/sgt/delete",
                    data : $.param({"api_key" : "Syh9yhgpdU", "student_id" : self.studentArray[studentId].id}),
                    method : "post",
                    dataType : "json",
//                    headers: {
//                        'Content-Type': "application/x-www-form-urlencoded"
//                    }
                };
                $http(req).then(function(response){
                    console.log(response);
                })
//                $.ajax({
//                    url:"http://s-apis.learningfuze.com/sgt/delete",
//                    dataType:"json",
//                    data:{
//                        api_key:"Syh9yhgpdU",
//                        student_id:self.studentArray[studentId].id
//                    },
//                    method:"post",
//                    success :function(response){
//                          console.log(response);
//                    }
//                })
            }

//            this.requestServerDelete = function(studentId){
//                var self = this;
//                console.log(self.studentArray[studentId]);
//                $.ajax({
//                    url:"http://s-apis.learningfuze.com/sgt/delete",
//                    dataType:"json",
//                    data:{
//                        api_key:"Syh9yhgpdU",
//                        student_id:self.studentArray[studentId].id
//                    },
//                    method:"post",
//                    success :function(response){
//                          console.log(response);
//                    }
//                })
//              };


//            this.sendDataToServer = function(){
//                var self =this;
//                $.ajax({
//                    url: "http://s-apis.learningfuze.com/sgt/create",
//                    dataType: "json",
//                    data: {
//                        api_key:"Syh9yhgpdU",
//                        name : self.studentArray[self.studentArray.length-1].name,
//                        course : self.studentArray[self.studentArray.length-1].course,
//                        grade : self.studentArray[self.studentArray.length-1].grade
//                    },
//                    method: "post",
//                    success: function(response){
//                        if(response.success){
//                            console.log("Data sent.");
//                            console.log(response);
//                        }
//                        else{
//                            console.log("Data not sent");
//                        }
//                    }
//                });
//            };

//            this.getDataFromServer = function(){ //when dom loads or when 'get data from server' button pressed
//                var self = this;
//                self.studentArray = [];
//                console.log("studentArray before ajax call",this.studentArray);
//                console.log("var self = this : ",self);
//                $.ajax({
//                    url: "http://s-apis.learningfuze.com/sgt/get",
//                    dataType: "json",
//                    data: {api_key:"Syh9yhgpdU"},
//                    method: "post",
//                    success: function(response){
//                        var studentDatabase = response.data;
//                        if (response.success){
//                            console.log("new info fetched from the server : ",response);
//                            console.log("var self = this inside the ajax success : ",self);
//                            //resetApplication(); //if data received successfully, reset student array;
//                            //$('tbody >tr').remove(); //remove current dom
//                            $scope.$apply(function(){
//                                console.log("$scope is applied");
//                                for (var i = 0; i < studentDatabase.length; i++ ){
//                                    ///need to use $http for ajax call in angular
//                                    self.addStudent(studentDatabase[i]);
//                                };
//                                self.calculateAverage();
//                            });
//                            //console.log("updated studentArray after ajax call : ",self.studentArray);
//                        }
//                    }
//                });
//            }
        this.getDataFromServer();
        });
                app.config(function($httpProvider){
                    $httpProvider.defaults.headers.post = {'Content-Type': 'application/x-www-form-urlencoded'};
                })
    </script>
</div>
</body>
</html>
